# Инструкция по обновлению API на сервере

## Команды для выполнения на сервере (167.99.37.111)

```bash
# 1. Подключиться к серверу
ssh root@167.99.37.111

# 2. Перейти в директорию проекта
cd /home/csvagent/Claude_code

# 3. Добавить директорию в safe для Git (если нужно)
git config --global --add safe.directory /home/csvagent/Claude_code

# 4. Получить обновления из репозитория
git pull origin claude/ai-csv-analysis-agent-011CUzRVkxApTixY8PTB45pS

# 5. Перезапустить сервис
systemctl restart csvagent

# 6. Проверить статус
systemctl status csvagent

# 7. Проверить логи (если нужно)
journalctl -u csvagent -f
```

## Что изменилось

### 1. Таблицы (DataFrame) теперь возвращаются с метаданными

**Раньше:**
```json
{
  "result_data": [
    {"State": "ALABAMA", "Year": 1992, ...},
    {"State": "ALASKA", "Year": 1993, ...}
  ]
}
```

**Теперь:**
```json
{
  "result_data": {
    "type": "dataframe",
    "data": [
      {"State": "ALABAMA", "Year": 1992, ...},
      {"State": "ALASKA", "Year": 1993, ...}
    ],
    "columns": ["State", "Year", "Salary"],
    "shape": {"rows": 5, "columns": 3},
    "dtypes": {"State": "object", "Year": "int64", "Salary": "float64"}
  }
}
```

Это позволит фронтенду правильно отображать таблицы вместо "[object Object]".

### 2. Умная обработка списков и многострочного текста

**Списки** (>3 коротких строк <150 символов) конвертируются в массивы:
```json
// Раньше:
{"result_data": "ALABAMA\nALASKA\nARIZONA\nARKANSAS"}

// Теперь:
{"result_data": ["ALABAMA", "ALASKA", "ARIZONA", "ARKANSAS"]}
```

**Многострочный текст** (длинные строки или <3 строк) сохраняется как есть:
```json
// Описание, отчет и т.д. - НЕ конвертируется
{"result_data": "Датасет содержит данные.\nПериод: 1990-2020."}
```

### 3. Вложенные объекты автоматически конвертируются в таблицы

**Раньше** агент мог вернуть вложенные объекты:
```json
{
  "result_data": {
    "Первый заказ": {"Страна": "Libya", "Дата": "2014-10-18"},
    "Второй заказ": {"Страна": "Ukraine", "Дата": "2014-11-13"}
  }
}
```
**Проблема:** Фронтенд показывал `[object Object]`

**Теперь** автоматически конвертируется в DataFrame:
```json
{
  "result_data": {
    "type": "dataframe",
    "data": [
      {"Страна": "Libya", "Дата": "2014-10-18"},
      {"Страна": "Ukraine", "Дата": "2014-11-13"}
    ],
    "columns": ["Страна", "Дата"]
  }
}
```
**Результат:** Красивая таблица!

### 4. Агент теперь объясняет что делает

**Раньше:** Агент молча возвращал результат
```
result_data: 51666.67
```

**Теперь:** Агент объясняет и анализирует
```
text_output: "Вычисляю среднюю зарплату по всем 51 штату...
Средняя зарплата составляет $51,666.67.
Интересно: разница между максимальной и минимальной составляет 38%"
```

### 5. Поддержка множественных CSV файлов

**Новый endpoint:** `POST /api/analyze-multi`

Теперь можно загрузить несколько файлов и делать перекрестный анализ!

**Пример:**
```bash
# Загрузить orders.csv и customers.csv
curl -X POST https://julius.sopods.store/api/analyze-multi \
  -F "files=@orders.csv" \
  -F "files=@customers.csv" \
  -F "query=Соедини таблицы и покажи топ-10 клиентов"
```

Агент автоматически получает доступ к переменным:
- `df` - первый файл (orders)
- `orders` - orders.csv
- `customers` - customers.csv

**Подробнее:** см. файл `MULTI_FILE_GUIDE.md`

### 6. Поддержка нескольких таблиц в одном ответе

**Проблема:** При запросе "выведи первые 5 строк каждой таблицы" агент выводил только одну таблицу красиво, остальные только текстом.

**Решение:** Агент теперь может возвращать **список таблиц**:

```python
# Код агента:
print("Выводим обе таблицы...")
result = [df.head(), data_sample.head()]  # Список DataFrame
```

**Результат:** Обе таблицы отображаются красиво!

## Все изменения:
- ✅ DataFrame с метаданными для правильного отображения таблиц
- ✅ Умная конвертация списков (>3 строк && <150 символов)
- ✅ Вложенные объекты автоматически → DataFrame
- ✅ Промпт для AI: использовать DataFrame вместо вложенных словарей
- ✅ Фронтенд: поддержка таблиц, списков, простых объектов, текста
- ✅ **НОВОЕ:** Агент объясняет что делает и анализирует результаты
- ✅ **НОВОЕ:** Поддержка множественных CSV файлов (endpoint /api/analyze-multi)
- ✅ **НОВОЕ:** Возврат нескольких таблиц в одном ответе (список DataFrame)
